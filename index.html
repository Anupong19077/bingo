<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Å‡∏°‡∏ö‡∏¥‡∏á‡πÇ‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }
        .bingo-card {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            aspect-ratio: 1 / 1;
        }
        .bingo-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            aspect-ratio: 1 / 1;
            padding: 4px;
            font-size: 0.8rem;
            line-height: 1.2;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            word-break: break-word;
            border: 2px solid transparent;
        }
        .bingo-cell.selected {
            background-color: #f59e0b; /* amber-500 */
            color: white;
            transform: scale(1.05);
            border-color: #d97706; /* amber-600 */
        }
        .bingo-cell.marked {
             background-color: #22c55e; /* green-500 */
             color: white;
             text-decoration: line-through;
        }
        .bingo-cell.winning-line {
            background-color: #ef4444; /* red-500 */
            border-color: #b91c1c; /* red-700 */
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1.05); }
            50% { transform: scale(1.15); }
        }
        #keyword-selection-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .keyword-chip {
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 9999px;
            transition: all 0.2s;
        }
        .keyword-chip.selected {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">
        
        <!-- Role Selection Screen -->
        <div id="role-selection-screen" class="text-center bg-white p-8 rounded-xl shadow-lg">
            <h1 class="text-4xl font-bold text-slate-700 mb-2">‡πÄ‡∏Å‡∏°‡∏ö‡∏¥‡∏á‡πÇ‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
            <p class="text-slate-500 mb-8">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button id="teacher-role-btn" class="bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-600 transition-colors shadow-md w-full md:w-auto">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π</button>
                <button id="student-btn" class="bg-amber-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-amber-600 transition-colors shadow-md w-full md:w-auto">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            </div>
             <div class="mt-8 text-xs text-slate-400">
                <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="auth-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span></p>
            </div>
        </div>
        
        <!-- Teacher Login/Register Screen -->
        <div id="teacher-login-screen" class="hidden bg-white p-8 rounded-xl shadow-lg">
             <h2 class="text-2xl font-bold mb-4 text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π</h2>
             <div class="mb-4">
                <label for="teacher-email" class="block text-slate-700 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                <input type="email" id="teacher-email" class="w-full p-3 border rounded-lg" placeholder="teacher@example.com">
            </div>
             <div class="mb-6">
                <label for="teacher-password" class="block text-slate-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                <input type="password" id="teacher-password" class="w-full p-3 border rounded-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="teacher-login-btn" class="flex-1 bg-indigo-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-600">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button id="teacher-register-btn" class="flex-1 bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            </div>
            <button id="login-back-btn" class="w-full mt-4 bg-slate-200 text-slate-700 font-bold py-2 px-6 rounded-lg hover:bg-slate-300">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>

        <!-- Teacher: Create Game Screen -->
        <div id="teacher-create-screen" class="hidden bg-white p-8 rounded-xl shadow-lg">
            <div class="flex justify-between items-start">
                <div>
                     <h2 class="text-2xl font-bold mb-1">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏°‡∏ö‡∏¥‡∏á‡πÇ‡∏Å</h2>
                     <p class="text-sm text-slate-500 mb-4" id="teacher-email-display"></p>
                </div>
                <button id="teacher-logout-btn" class="bg-red-500 text-white font-bold py-1 px-3 text-sm rounded-lg hover:bg-red-600">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
            <p class="mb-4 text-slate-600">‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÄ‡∏Å‡∏° (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 24 ‡∏Ñ‡∏≥) ‡πÇ‡∏î‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</p>
            <textarea id="keywords-input" class="w-full h-48 p-3 border rounded-lg focus:ring-2 focus:ring-indigo-400" placeholder="‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà 1&#10;‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà 2&#10;‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà 3..."></textarea>
            <p id="keyword-count" class="text-sm text-slate-500 mt-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥: 0</p>
            <button id="create-game-btn" class="mt-6 w-full bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-600 disabled:bg-slate-300" disabled>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà</button>
        </div>
        
        <!-- Student: Join Game Screen -->
        <div id="student-join-screen" class="hidden bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Å‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</h2>
            <div class="mb-4">
                <label for="game-code-input" class="block text-slate-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á</label>
                <input type="text" id="game-code-input" class="w-full p-3 border rounded-lg uppercase" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 6 ‡∏ï‡∏±‡∏ß">
            </div>
            <div class="mb-6">
                <label for="student-name-input" class="block text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</label>
                <input type="text" id="student-name-input" class="w-full p-3 border rounded-lg" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
            </div>
            <div class="flex gap-4">
                <button id="join-game-btn" class="bg-amber-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-amber-600">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
                <button id="join-back-btn" class="bg-slate-200 text-slate-700 font-bold py-2 px-6 rounded-lg hover:bg-slate-300">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>
        </div>
        
        <!-- Lobby/Keyword Selection Screen (for Student) -->
        <div id="keyword-selection-screen" class="hidden bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏¥‡∏á‡πÇ‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
            <p class="text-slate-600 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 24 ‡∏Ñ‡∏≥ (‡∏à‡∏∞‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á "‡∏ü‡∏£‡∏µ" ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á) ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏¥‡∏á‡πÇ‡∏Å"</p>
            <p class="font-bold text-xl mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß <span id="selected-keyword-count">0</span>/24 ‡∏Ñ‡∏≥</p>
            <div id="keyword-selection-grid" class="p-4 bg-slate-50 rounded-lg max-h-60 overflow-y-auto mb-4 border"></div>
             <div class="mt-6">
                <h3 class="font-bold mb-2">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á</h3>
                <ul id="lobby-player-list" class="list-disc list-inside text-slate-600"></ul>
            </div>
            <button id="create-bingo-card-btn" class="mt-6 bg-blue-500 text-white font-bold py-3 px-6 rounded-lg w-full hover:bg-blue-600 disabled:bg-slate-300" disabled>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏¥‡∏á‡πÇ‡∏Å</button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
            <div class="flex flex-col lg:flex-row gap-6">
                <div class="w-full lg:w-1/2">
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h2 class="text-xl font-bold">‡∏´‡πâ‡∏≠‡∏á: <span id="game-code-display" class="text-indigo-600"></span></h2>
                                <p class="text-sm text-slate-500">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: <span id="player-name-display"></span></p>
                            </div>
                            <button id="bingo-btn" class="bg-rose-500 text-white font-extrabold text-2xl py-2 px-8 rounded-lg shadow-lg hover:bg-rose-600 transform hover:scale-105 transition-all">BINGO!</button>
                        </div>
                        <div id="bingo-card-container" class="bingo-card"></div>
                    </div>
                </div>
                <div class="w-full lg:w-1/2">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div id="teacher-controls" class="hidden">
                            <h3 class="text-xl font-bold mb-4">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π</h3>
                            <div id="winner-announcement" class="hidden mb-4 text-center p-4 bg-yellow-100 rounded-lg">
                                <p class="font-bold text-lg text-yellow-800">üéâ BINGO! üéâ</p>
                                <p id="winner-name-text" class="text-yellow-700"></p>
                                <button id="view-winner-card-btn" class="mt-2 text-sm text-indigo-600 hover:underline">‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞</button>
                            </div>
                             <button id="draw-keyword-btn" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-colors shadow-md mb-4">‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡∏°‡πà</button>
                             <button id="reset-game-btn" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°</button>
                             <div class="mt-4">
                                <h4 class="font-bold">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á:</h4>
                                <ul id="game-player-list" class="list-disc list-inside text-slate-600 mt-2 max-h-40 overflow-y-auto"></ul>
                            </div>
                        </div>
                        <div id="student-info">
                            <h3 class="text-xl font-bold mb-2">‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                            <div id="last-drawn-keyword" class="w-full bg-amber-100 border-2 border-amber-400 text-amber-800 text-2xl font-bold p-4 rounded-lg text-center min-h-[80px] flex items-center justify-center">‡∏£‡∏≠‡∏Ñ‡∏£‡∏π‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...</div>
                        </div>
                        <div class="mt-4">
                            <h4 class="text-lg font-bold mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ (<span id="drawn-count">0</span>)</h4>
                            <div id="drawn-keywords-list" class="flex flex-wrap gap-2 bg-slate-50 p-3 rounded-lg max-h-48 overflow-y-auto border"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div id="modal-content" class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center">
                <h3 id="modal-title" class="text-2xl font-bold mb-4"></h3>
                <p id="modal-body" class="text-slate-600 mb-6"></p>
                <div id="modal-winner-card-container" class="hidden mb-4"></div>
                <button id="modal-close-btn" class="bg-indigo-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-600">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, off, remove, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAq-jzZj6A9UW5MfenpJWrLxNL5rJWa1b4",
            authDomain: "bingo-fc56e.firebaseapp.com",
            databaseURL: "https://bingo-fc56e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bingo-fc56e",
            storageBucket: "bingo-fc56e.firebasestorage.app",
            messagingSenderId: "164024050479",
            appId: "1:164024050479:web:63482a2f93ec85d6cd77da",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let currentGameCode = null;
        let currentGameRef = null;
        let currentPlayerRef = null;
        let gameListener = null;
        const FREE_SPACE_KEYWORD = "FREE_SPACE";

        const screens = {
            role: document.getElementById('role-selection-screen'),
            teacherLogin: document.getElementById('teacher-login-screen'),
            teacherCreate: document.getElementById('teacher-create-screen'),
            studentJoin: document.getElementById('student-join-screen'),
            keywordSelection: document.getElementById('keyword-selection-screen'),
            game: document.getElementById('game-screen'),
        };

        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalWinnerCardContainer = document.getElementById('modal-winner-card-container');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        
        const showScreen = (screenName) => {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            if(screens[screenName]) screens[screenName].classList.remove('hidden');
        };

        const showModal = (title, body, winnerCardInfo = null) => {
            modalTitle.textContent = title;
            modalBody.textContent = body;
            if (winnerCardInfo) {
                modalWinnerCardContainer.innerHTML = '';
                const bingoCardDiv = document.createElement('div');
                bingoCardDiv.className = 'bingo-card mx-auto max-w-[250px]';
                modalWinnerCardContainer.appendChild(bingoCardDiv);
                renderBingoCard(winnerCardInfo.card, winnerCardInfo.drawnKeywords, winnerCardInfo.winPattern, bingoCardDiv);
                modalWinnerCardContainer.classList.remove('hidden');
            } else {
                modalWinnerCardContainer.classList.add('hidden');
            }
            modal.classList.remove('hidden');
        };

        modalCloseBtn.onclick = () => modal.classList.add('hidden');
        
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const authStatusSpan = document.getElementById('auth-status');
            if (user && !user.isAnonymous) {
                authStatusSpan.textContent = `‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏£‡∏π: ${user.email}`;
                document.getElementById('teacher-email-display').textContent = `‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ${user.email}`;
                showScreen('teacherCreate');
            } else if (user && user.isAnonymous) {
                authStatusSpan.textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";
            } else {
                authStatusSpan.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠";
                signInAnonymously(auth).catch(e => console.error("Anonymous sign-in failed", e));
            }
        });

        // --- Event Listeners for screen navigation ---
        document.getElementById('teacher-role-btn').onclick = () => {
            if (currentUser && !currentUser.isAnonymous) {
                showScreen('teacherCreate');
            } else {
                showScreen('teacherLogin');
            }
        };
        document.getElementById('student-btn').onclick = () => showScreen('studentJoin');
        document.getElementById('login-back-btn').onclick = () => showScreen('role');
        document.getElementById('join-back-btn').onclick = () => showScreen('role');

        
        // --- Teacher Auth Flow ---
        document.getElementById('teacher-login-btn').onclick = () => {
            const email = document.getElementById('teacher-email').value;
            const pass = document.getElementById('teacher-password').value;
            signInWithEmailAndPassword(auth, email, pass)
                .catch(err => showModal("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", err.message));
        };
        document.getElementById('teacher-register-btn').onclick = () => {
            const email = document.getElementById('teacher-email').value;
            const pass = document.getElementById('teacher-password').value;
            createUserWithEmailAndPassword(auth, email, pass)
                .catch(err => showModal("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", err.message));
        };
        document.getElementById('teacher-logout-btn').onclick = () => {
            signOut(auth);
            showScreen('role');
        };

        // --- Teacher Create Game Flow ---
        const keywordsInput = document.getElementById('keywords-input');
        const createGameBtn = document.getElementById('create-game-btn');
        keywordsInput.addEventListener('input', () => {
            const keywords = keywordsInput.value.trim().split('\n').filter(k => k.trim() !== '');
            document.getElementById('keyword-count').textContent = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥: ${keywords.length}`;
            createGameBtn.disabled = keywords.length < 24;
        });

        createGameBtn.onclick = async () => {
            if (!currentUser || currentUser.isAnonymous) {
                 showModal("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏£‡∏π‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏°");
                 return;
            }
            const gameCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            const keywords = keywordsInput.value.trim().split('\n').filter(k => k.trim() !== '');
            
            const gameData = {
                teacherId: currentUser.uid,
                status: 'waiting',
                keywords: keywords,
                drawnKeywords: [],
                players: {},
                createdAt: new Date().toISOString()
            };

            await set(ref(db, `games/${gameCode}`), gameData);
            await joinGame(gameCode, '‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô', true);
        };

        // --- Student Flow ---
        document.getElementById('join-game-btn').onclick = async () => {
            const gameCode = document.getElementById('game-code-input').value.trim().toUpperCase();
            const studentName = document.getElementById('student-name-input').value.trim();

            if (!gameCode || !studentName) return showModal("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô");
            
            const gameRefCheck = ref(db, `games/${gameCode}`);
            const snapshot = await get(gameRefCheck);
            if (!snapshot.exists()) return showModal("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏°", "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

            const gameData = snapshot.val();
            if (gameData.players && Object.values(gameData.players).find(p => p.name === studentName)) {
                return showModal("‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥", "‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô");
            }
            await joinGame(gameCode, studentName, false);
        };

        const joinGame = async (gameCode, playerName, isTeacher) => {
            currentGameCode = gameCode;
            currentGameRef = ref(db, `games/${gameCode}`);
            
            const playerInfo = {
                name: playerName,
                isTeacher: isTeacher,
                isReady: isTeacher,
                card: [],
            };
            
            currentPlayerRef = ref(db, `games/${gameCode}/players/${currentUser.uid}`);
            await set(currentPlayerRef, playerInfo);

            if (isTeacher) {
                setupGameScreen(isTeacher, playerName);
            } else {
                setupKeywordSelectionScreen();
            }

            if (gameListener) off(currentGameRef, 'value', gameListener);
            gameListener = onValue(currentGameRef, (snapshot) => {
                if (snapshot.exists()) {
                    updateUIWithGameData(snapshot.val(), isTeacher);
                } else {
                    cleanupAndExit("‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏°‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß", "‡∏Ñ‡∏£‡∏π‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
                }
            });
        };
        
        const setupKeywordSelectionScreen = () => {
            showScreen('keywordSelection');
            const selectionGrid = document.getElementById('keyword-selection-grid');
            const selectedCountSpan = document.getElementById('selected-keyword-count');
            const createCardBtn = document.getElementById('create-bingo-card-btn');
            
            onValue(ref(db, `games/${currentGameCode}/keywords`), (snapshot) => {
                const keywords = snapshot.val();
                selectionGrid.innerHTML = '';
                let selectedKeywords = new Set();

                keywords.forEach(keyword => {
                    const chip = document.createElement('div');
                    chip.textContent = keyword;
                    chip.className = 'keyword-chip bg-slate-200';
                    chip.onclick = () => {
                        if (selectedKeywords.has(keyword)) {
                            selectedKeywords.delete(keyword);
                            chip.classList.remove('selected');
                        } else {
                            if (selectedKeywords.size < 24) {
                                selectedKeywords.add(keyword);
                                chip.classList.add('selected');
                            }
                        }
                        selectedCountSpan.textContent = selectedKeywords.size;
                        createCardBtn.disabled = selectedKeywords.size !== 24;
                    };
                    selectionGrid.appendChild(chip);
                });
            }, { onlyOnce: true });

            createCardBtn.onclick = async () => {
                let cardKeywords = Array.from(selectionGrid.querySelectorAll('.keyword-chip.selected')).map(c => c.textContent);
                cardKeywords = cardKeywords.sort(() => Math.random() - 0.5); // Shuffle
                cardKeywords.splice(12, 0, FREE_SPACE_KEYWORD); // Insert FREE space at the center
                
                const updates = {};
                updates[`/games/${currentGameCode}/players/${currentUser.uid}/card`] = cardKeywords;
                updates[`/games/${currentGameCode}/players/${currentUser.uid}/isReady`] = true;
                await update(ref(db), updates);
            };
        };

        const setupGameScreen = (isTeacher, playerName) => {
            showScreen('game');
            document.getElementById('game-code-display').textContent = currentGameCode;
            document.getElementById('player-name-display').textContent = playerName;

            document.getElementById('teacher-controls').classList.toggle('hidden', !isTeacher);
            document.getElementById('student-info').classList.toggle('hidden', isTeacher);
            document.getElementById('bingo-btn').classList.toggle('hidden', isTeacher);
        };
        
        const updateUIWithGameData = (gameData, isTeacher) => {
            const me = gameData.players[currentUser.uid];
            if (!me) return cleanupAndExit("‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß", "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ");
            
            if (!isTeacher && !me.isReady) {
                 if (screens.keywordSelection.classList.contains('hidden')) setupKeywordSelectionScreen();
                 const lobbyPlayerList = document.getElementById('lobby-player-list');
                 lobbyPlayerList.innerHTML = '';
                 Object.values(gameData.players).forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.name} ${p.isReady ? '‚úÖ' : '...'}`;
                    lobbyPlayerList.appendChild(li);
                 });
                 return;
            }

            if (screens.game.classList.contains('hidden')) setupGameScreen(isTeacher, me.name);
            
            renderBingoCard(me.card || [], gameData.drawnKeywords || [], gameData.winner?.pattern);
            
            const drawnKeywords = gameData.drawnKeywords || [];
            document.getElementById('drawn-count').textContent = drawnKeywords.length;
            document.getElementById('last-drawn-keyword').textContent = drawnKeywords.length > 0 ? drawnKeywords.slice(-1)[0] : '‡∏£‡∏≠‡∏Ñ‡∏£‡∏π‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...';
            const drawnList = document.getElementById('drawn-keywords-list');
            drawnList.innerHTML = '';
            drawnKeywords.slice().reverse().forEach(keyword => {
                const span = document.createElement('span');
                span.className = 'bg-white px-2 py-1 rounded text-sm border';
                span.textContent = keyword;
                drawnList.appendChild(span);
            });
            
            const isFinished = gameData.status === 'finished';

            if (isTeacher) {
                const remaining = new Set([...gameData.keywords].filter(x => !new Set(drawnKeywords).has(x)));
                document.getElementById('draw-keyword-btn').disabled = remaining.size === 0 || isFinished;
                
                const winnerAnnounce = document.getElementById('winner-announcement');
                if (isFinished && gameData.winner) {
                    document.getElementById('winner-name-text').textContent = `‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞: ${gameData.winner.name}`;
                    winnerAnnounce.classList.remove('hidden');
                } else {
                    winnerAnnounce.classList.add('hidden');
                }
            }
            
            document.getElementById('bingo-btn').disabled = isFinished;
        };

        const renderBingoCard = (cardData, drawnKeywords, winPattern = [], container = document.getElementById('bingo-card-container')) => {
            container.innerHTML = '';
            const drawnSet = new Set(drawnKeywords);
            const winSet = new Set(winPattern);

            cardData.forEach((keyword, index) => {
                const cell = document.createElement('div');
                const isFreeSpace = keyword === FREE_SPACE_KEYWORD;
                cell.textContent = isFreeSpace ? "‡∏ü‡∏£‡∏µ" : keyword;
                cell.className = 'bingo-cell bg-slate-100 rounded-lg';
                cell.dataset.index = index;

                if (isFreeSpace || drawnSet.has(keyword)) {
                    cell.classList.add('marked');
                }
                if (isFreeSpace) {
                    cell.classList.add('selected'); // Auto-select free space
                }
                if(winSet.has(index)) {
                    cell.classList.add('winning-line');
                }

                if(cell.classList.contains('marked') && !isFreeSpace){
                    cell.onclick = () => cell.classList.toggle('selected');
                } else {
                    cell.style.cursor = 'not-allowed';
                }
                container.appendChild(cell);
            });
        };

        document.getElementById('draw-keyword-btn').onclick = async () => {
             const snapshot = await get(currentGameRef);
             const gameData = snapshot.val();
             if (gameData.status === 'finished') return;

             const remaining = [...gameData.keywords].filter(x => !(gameData.drawnKeywords || []).includes(x));
             if(remaining.length > 0) {
                 const newKeyword = remaining[Math.floor(Math.random() * remaining.length)];
                 const updates = {
                     [`/games/${currentGameCode}/drawnKeywords`]: [...(gameData.drawnKeywords || []), newKeyword],
                     [`/games/${currentGameCode}/status`]: 'playing'
                 };
                 await update(ref(db), updates);
             }
        };
        
        document.getElementById('reset-game-btn').onclick = async () => {
            if (!window.confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°? ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡∏°‡πà')) return;
            
            const playersSnapshot = await get(ref(db, `games/${currentGameCode}/players`));
            const players = playersSnapshot.val();
            const updates = {};
            updates[`/games/${currentGameCode}/status`] = 'waiting';
            updates[`/games/${currentGameCode}/drawnKeywords`] = [];
            updates[`/games/${currentGameCode}/winner`] = null;

            Object.keys(players).forEach(uid => {
                updates[`/games/${currentGameCode}/players/${uid}/card`] = [];
                updates[`/games/${currentGameCode}/players/${uid}/isReady`] = players[uid].isTeacher;
            });
            await update(ref(db), updates);
            showModal("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°", "‡πÄ‡∏Å‡∏°‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
        };

        document.getElementById('view-winner-card-btn').onclick = async () => {
            const snapshot = await get(currentGameRef);
            const gameData = snapshot.val();
            if(!gameData.winner) return;

            const winnerPlayer = gameData.players[gameData.winner.uid];
            showModal(
                `‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á ${gameData.winner.name}`, 
                `‡∏ö‡∏¥‡∏á‡πÇ‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏µ`,
                { 
                    card: winnerPlayer.card, 
                    drawnKeywords: gameData.drawnKeywords, 
                    winPattern: gameData.winner.pattern 
                }
            );
        };

        document.getElementById('bingo-btn').onclick = async () => {
            const selectedCells = document.querySelectorAll('#bingo-card-container .bingo-cell.selected');
            const snapshot = await get(currentGameRef);
            const gameData = snapshot.val();
            
            if (gameData.status === 'finished') return;

            const markedIndices = new Set(Array.from(selectedCells).map(c => parseInt(c.dataset.index)));
            const winPattern = checkWin(markedIndices);

            if (winPattern) {
                const me = gameData.players[currentUser.uid];
                const updates = {};
                updates[`/games/${currentGameCode}/status`] = 'finished';
                updates[`/games/${currentGameCode}/winner`] = { name: me.name, uid: currentUser.uid, pattern: winPattern };
                await update(ref(db), updates);
            } else {
                showModal("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏¥‡∏á‡πÇ‡∏Å!", "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö 5 ‡∏Ñ‡∏≥");
            }
        };

        const checkWin = (markedIndices) => {
            const winPatterns = [
                [0, 1, 2, 3, 4], [5, 6, 7, 8, 9], [10, 11, 12, 13, 14], [15, 16, 17, 18, 19], [20, 21, 22, 23, 24],
                [0, 5, 10, 15, 20], [1, 6, 11, 16, 21], [2, 7, 12, 17, 22], [3, 8, 13, 18, 23], [4, 9, 14, 19, 24],
                [0, 6, 12, 18, 24], [4, 8, 12, 16, 20]
            ];
            for (const pattern of winPatterns) {
                if (pattern.every(index => markedIndices.has(index))) {
                    return pattern;
                }
            }
            return null;
        };

        const cleanupAndExit = (title, message) => {
             if (currentGameRef && gameListener) off(currentGameRef, 'value', gameListener);
             currentGameCode = null;
             currentGameRef = null;
             currentPlayerRef = null;
             gameListener = null;

             showModal(title, message);
             showScreen('role');
        };

        window.addEventListener('beforeunload', () => {
             if (currentPlayerRef && !currentUser?.isTeacher) remove(currentPlayerRef);
        });
        
        showScreen('role');

    </script>
</body>
</html>
